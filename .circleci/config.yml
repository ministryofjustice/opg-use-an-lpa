version: 2.1

workflows:
  path_to_live:
    jobs:
      - use-my-lpa/docker_build_view:
          name: build_view_containers
      - use-my-lpa/lint_terraform:
          name: lint_terraform
          workspace: development
      - use-my-lpa/apply_terraform:
          name: apply_terraform_devlopment
          workspace: development
          requires: [lint_terraform, build_view_containers]
          filters:
            branches:
              ignore: master
      - use-my-lpa/apply_terraform:
          name: apply_terraform_preproduction
          workspace: preproduction
          filters:
            branches:
              only: master
      - use-my-lpa/apply_terraform:
          name: apply_terraform_production
          workspace: production
          requires: [apply_terraform_preproduction]
          filters:
            branches:
              only: master
orbs:
  use-my-lpa:
    executors:
      ruby:
        docker: [image: circleci/ruby:latest-browsers]
      terraform:
        docker: [image: hashicorp/terraform]
      python:
        docker: [image: circleci/python:3.6.1]
    jobs:
      lint_terraform:
        executor: terraform
        parameters:
          workspace:
            description: Terraform workspace name
            type: string
            default: development
        environment:
          TF_WORKSPACE: "<<parameters.workspace>>"
        steps:
          - checkout
          - run:
              name: Lint Terraform
              command: |
                cd terraform
                terraform init
                terraform validate
      apply_terraform:
        executor: terraform
        parameters:
          workspace:
            description: Terraform workspace name
            type: string
            default: development
        environment:
          TF_WORKSPACE: "<<parameters.workspace>>"
        steps:
          - checkout
          - run:
              name: Apply Terraform
              command: |
                cd terraform
                terraform init
                terraform apply --auto-approve
      docker_build_view:
        executor: python
        steps:
          - checkout
          - setup_remote_docker:
              version: 18.06.0-ce
          - run:
              name: Install awscli
              command: |
                python3 -m venv venv
                . venv/bin/activate
                pip install --user --quiet awscli
          - run:
              name: Build
              command: |
                docker-compose build
          - run:
              name: push
              command: |
                . venv/bin/activate
                eval $(~/bin/aws ecr get-login --no-include-email --region=eu-west-1)
                docker tag opgusemylpa_viewer-app:latest use_my_lpa/view_lpa_front:latest
                docker tag use_my_lpa/view_lpa_front:latest 311462405659.dkr.ecr.eu-west-1.amazonaws.com/use_my_lpa/view_lpa_front:latest
                docker push 311462405659.dkr.ecr.eu-west-1.amazonaws.com/use_my_lpa/view_lpa_front:latest
                docker tag opgusemylpa_viewer-web:latest use_my_lpa/web:latest
                docker tag use_my_lpa/web:latest 311462405659.dkr.ecr.eu-west-1.amazonaws.com/use_my_lpa/web:latest
                docker push 311462405659.dkr.ecr.eu-west-1.amazonaws.com/use_my_lpa/web:latest
