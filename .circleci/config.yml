version: 2.1

workflows:
  path_to_live:
    jobs:
      - use-my-lpa/docker_build_view:
          name: build_view_containers
      - use-my-lpa/lint_terraform:
          name: lint_terraform
          workspace: development
      - use-my-lpa/apply_terraform:
          name: apply_terraform_devlopment
          workspace: development
          requires: [lint_terraform, build_view_containers]
          filters:
            branches:
              ignore: master
      - use-my-lpa/apply_terraform:
          name: apply_terraform_preproduction
          workspace: preproduction
          filters:
            branches:
              only: master
      - use-my-lpa/apply_terraform:
          name: apply_terraform_production
          workspace: production
          requires: [apply_terraform_preproduction]
          filters:
            branches:
              only: master
orbs:
  use-my-lpa:
    commands:
      install_aws_cli:
        steps:
          - run:
              name: install_aws_cli
              command: |
                curl "https://s3.amazonaws.com/aws-cli/awscli-bundle.zip" -o "awscli-bundle.zip"
                unzip awscli-bundle.zip
                ./awscli-bundle/install -b ~/bin/aws
                /home/circleci/bin/aws --version

    executors:
      ruby:
        docker: [image: circleci/ruby:latest-browsers]
      terraform:
        docker: [image: hashicorp/terraform]
      aws:
        docker: [image: cibuilds/aws:1.16]
    jobs:
      lint_terraform:
        executor: terraform
        parameters:
          workspace:
            description: Terraform workspace name
            type: string
            default: development
        environment:
          TF_WORKSPACE: "<<parameters.workspace>>"
        steps:
          - checkout
          - run:
              name: Lint Terraform
              command: |
                cd terraform
                terraform init
                terraform validate
      apply_terraform:
        executor: terraform
        parameters:
          workspace:
            description: Terraform workspace name
            type: string
            default: development
        environment:
          TF_WORKSPACE: "<<parameters.workspace>>"
        steps:
          - checkout
          - run:
              name: Apply Terraform
              command: |
                cd terraform
                terraform init
                terraform apply --auto-approve
      docker_build_view:
        executor: aws
        steps:
          - checkout
          - run:
              name: Build
              command: |
                # Build app
                docker-compose build viewer-web
                docker-compose build viewer-app
          - run:
              name: Deploy
              command: |
                # git tag $CIRCLE_BUILD_NUM
                # git push --tags

                docker images
                ./docker_login.sh
                docker-compose push viewer-app
                docker tag 311462405659.dkr.ecr.eu-west-1.amazonaws.com/use_my_lpa/view_lpa_front:latest 311462405659.dkr.ecr.eu-west-1.amazonaws.com/use_my_lpa/view_lpa_front:$CIRCLE_BUILD_NUM
                docker push 311462405659.dkr.ecr.eu-west-1.amazonaws.com/use_my_lpa/view_lpa_front:$CIRCLE_BUILD_NUM

                docker-compose push viewer-web
                docker tag 311462405659.dkr.ecr.eu-west-1.amazonaws.com/use_my_lpa/web:latest 311462405659.dkr.ecr.eu-west-1.amazonaws.com/use_my_lpa/web:$CIRCLE_BUILD_NUM
                docker push 311462405659.dkr.ecr.eu-west-1.amazonaws.com/use_my_lpa/web:$CIRCLE_BUILD_NUM
