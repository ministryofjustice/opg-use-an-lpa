
name: "[Workflow] Post Statistics to Slack"

on:
  pull_request:
    paths:
      - '.github/workflows/statistics.yml'
    branches:
      - main
  schedule:
    - cron: "0 9 * * 1" # 9am every Monday
  workflow_dispatch:

defaults:
  run:
    shell: bash
jobs:
  stats_to_slack:
    name: "Post service stats to Slack"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4.3.0
      - name: Setup AWS credentials
        uses: aws-actions/configure-aws-credentials@7474bc4690e29a8392af63c5b98e7449536d5c3a # v4.3.1
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID_ACTIONS }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY_ACTIONS }}
          aws-region: eu-west-1
          role-duration-seconds: 1800
          role-session-name: OPGGetServiceStats
      - name: Set up Python
        uses: actions/setup-python@e797f83bcb11b83ae66e0230d6156d7c80228e7c # v6.0.0
        with:
          python-version: 3.13.7
      - name: Install requirements
        run: |
          pip install -r ./scripts/pipeline/requirements.txt
      - name: Get stats
        run: |
          python ./scripts/get_statistics/get_statistics.py > ./stats.json
      - name: Show stats in summary (debug only)
        if: runner.debug == '1'
        run: |
          stat_content=$(cat ./stats.md)
          echo "${stat_content}" >> $GITHUB_STEP_SUMMARY
      - name: Post to Slack
        env:
          SLACK_WEB_HOOK: ${{ secrets.STATS_SLACK_WEBHOOK }}
        run: |
          python ./scripts/pipeline/service_stats_to_slack/stats_slack_notification.py \
          --slack_webhook ${{ env.SLACK_WEB_HOOK }} \
          --template_path ./scripts/pipeline/service_stats_to_slack/service_stats.txt \
          --stats_path ./stats.json
