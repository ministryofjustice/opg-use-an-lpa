version: '3.8'

services:

  dynamodb-local:
    command: "-jar DynamoDBLocal.jar -sharedDb"
    image: "amazon/dynamodb-local:latest"
    container_name: dynamodb-local
    ports:
      - 8000:8000

  # -----
  # Code Generation API development environment
  # -----

  codes-gateway:
    build:
      context: ../opg-data-lpa-codes/lambda_functions/v1
      dockerfile: Dockerfile-Local-Helper
    ports:
      - 4343:4343
    volumes:
      - ../opg-data-lpa-codes/lambda_functions/v1/:/var/www/lambda_functions/v1/
    depends_on:
      - dynamodb-local
    environment:
      LOCAL_URL: host.docker.internal #rather than host name as the port is hardcoded to 8000
      ENVIRONMENT: local
      AWS_ACCESS_KEY_ID: testing
      AWS_SECRET_ACCESS_KEY: testing
      AWS_SECURITY_TOKEN: testing
      AWS_SESSION_TOKEN: testing
      AWS_DEFAULT_REGION: eu-west-1

  # ---------------------------
  # Cache service

  redis:
    image: redis:5

  # ---------------------------
  # AWS KMS mock service

  kms:
    image: nsmithuk/local-kms:3
    volumes:
      - ./local-config/kms:/init
    environment:
      KMS_REGION: eu-west-1
      KMS_SEED_PATH: /init/kms-seed.yaml

  # ---------------------------
  # Sirius gateway mock
  api-gateway:
    container_name: api-gateway
    image: nginx:stable-alpine
    depends_on:
      - mock-data-lpa
      - mock-image-request-handler
    ports:
      - "4010:5000"
    volumes:
      - ./mock-integrations/nginx.conf:/etc/nginx/conf.d/default.conf
      - ./mock-integrations/image-request-handler/mocked-images:/var/www/html:ro

  mock-data-lpa:
    container_name: mock-data-lpa
    image: stoplight/prism:4
    command:
      - "mock"
      - "-h"
      - "0.0.0.0"
      - "/tmp/openapi.yaml"
    ports:
      - "4011:4010"
    volumes:
      - ./mock-integrations/opg-data-lpa/mock-openapi.yaml:/tmp/openapi.yaml:ro

  mock-image-request-handler:
    container_name: mock-image-request-handler
    image: outofcoffee/imposter:3.31.6
    command:
      - "-c"
      - "/opt/imposter/config"
      - "-l"
      - "4012"
    ports:
      - "4012:4012"
    volumes:
      - ./mock-integrations/image-request-handler:/opt/imposter/config:ro

  localstack:
    container_name: localstack
    image: localstack/localstack
    ports:
      - "4566:4566"
    environment:
      - DEBUG=1
    volumes:
      - ./mock-integrations/secrets-manager/localstack_init.sh:/etc/localstack/init/ready.d/init-aws.sh
      - ./mock-integrations/secrets-manager/private_key.pem:/private_key.pem
      - ./mock-integrations/secrets-manager/public_key.pem:/public_key.pem
      - ./mock-integrations/secrets-manager/onelogin_mock_public_key.pem:/onelogin_mock_public_key.pem

  mock-one-login:
    container_name: mock-one-login
    image: 311462405659.dkr.ecr.eu-west-1.amazonaws.com/use_an_lpa/mock_onelogin_app:v0.58.0
    ports:
      - "4013:8080"
    environment:
      PUBLIC_URL: http://localhost:4013
      INTERNAL_URL: http://mock-one-login:8080
      REDIRECT_URL: https://localhost:9042/home/login
      CLIENT_ID: client-id
