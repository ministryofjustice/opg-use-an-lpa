#!/usr/bin/env bash

# count LPAs added between the specified dates, by doing a DynamoDB scan and reducing this down todate unique SiriusUids so that we don't count LPAs twice when 
# added todate more than one account

get_lpas() {
    aws dynamodb scan \
      --table-name $environment-UserLpaActorMap \
      --filter-expression "Added BETWEEN :fromdate AND :todate" \
      --expression-attribute-values "{ \":fromdate\" : { \"S\" : \"$fromdate\" }, \":todate\" : { \"S\" : \"$todate\" } }" \
      | jq '.Items[].SiriusUid.S' | sort | uniq | wc -l
}

# if no args supplied, default to demo environment
if [ $# -lt 1 ]
then
    environment="demo"
else
    environment=$1
fi
# if less than 2 args supplied, then as a default, use today and a month ago as todate and fromdate 
if [ $# -lt 3 ]
then
    todate=$(date +"%Y-%m-%d")
# handle different date command on Mac and Linux
    if [ $(uname) == "Darwin" ] 
    then
        fromdate=$(date -v-1m +"%Y-%m-%d")
    else
        fromdate=$(date -d "1 month ago" +"%Y-%m-%d")
    fi
else
# if 3 args were supplied, we use 2cnd and 3rd as fromdate and todate
    fromdate=$2
    todate=$3
fi
echo "LPAs in $environment environment added between $fromdate and $todate:"
get_lpas 

